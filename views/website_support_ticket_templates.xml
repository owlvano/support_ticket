<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>
  
  <template id="assets_frontend" inherit_id="web.assets_frontend" name="website support ticket frontend assets">
      <xpath expr="." position="inside">
        <link href="/support_ticket/static/src/fancygrid/fancy.min.css" rel="stylesheet"/>
        <link href="/support_ticket/static/src/css/fancygrid.style.css" rel="stylesheet"/>
        <script src="/support_ticket/static/src/fancygrid/fancy.min.js"></script>

        <script>Fancy.MODULESDIR = '/support_ticket/static/src/fancygrid/modules/';</script>
      </xpath>
  </template>

  <template id="website_support.support_ticket_view_list" name="My Support Tickets" page="True">
    <t t-call="website.layout">
        <div class="container">

          <div class="mt16 mb16">
            <h1 class="text-center">My Support Tickets</h1>
          </div>
      

          <script>

            $(document).ready(function() {

              function load_support_tickets() {
                var tickets = new Array();

                <t t-foreach="support_tickets" t-as="support_ticket">                
                  tickets.push({
                    personName: "<t t-esc="support_ticket.person_name"/>", 
                    subject: "<t t-esc="support_ticket.subject"/>",
                    category: "<t t-esc="support_ticket.category.name"/>",
                    state: "<t t-esc="support_ticket.state.name"/>",
                    createDate: "<t t-esc="support_ticket.create_date"/>",
                    viewBtn: '<a class="btn btn-info" t-attf-href="/support/ticket/view/#{support_ticket.id}">View</a>'      
                  });
                </t>

                return tickets;
              }

              function unique(arr, prop) {
                return arr.map(function(e) { return e[prop]; }).filter(function(e,i,a){
                    return i === a.indexOf(e);
                });
              }

              function getFormattedDate(){
                return ['<p>d-m-y</p>', '<p>H:i</p>'].join("");
              }

              var ticketData = load_support_tickets();

              $('#ticketgrid').FancyGrid({    
                width: 700,
                height: 400,
                data: ticketData,
                selModel: 'row',
                cellHeight: 75,
                cellWrapper: true,
                defaults: {
                  ellipsis: true,
                  flex: 1
                },
                columns: [{
                  index: 'personName',      
                  title: 'Заявитель',
                  type: 'string',
                  filter: {
                    header: true,
                    emptyText: 'Search'
                  }
                },{
                  index: 'subject',
                  title: 'Тема',
                  type: 'string',
                  flex: 2,
                  filter: {
                    header: true,
                    emptyText: 'Search'
                  }
                },{
                  index: 'category',
                  title: 'Категория',
                  type: 'combo',
                  multiSelect: true, 
                  itemCheckBox: true,
                  data: unique(ticketData, 'category'),
                  filter: {
                    header: true,
                    emptyText: 'Search'
                  }
                },{
                  index: 'state',
                  title: 'Состояние',
                  type: 'combo',
                  multiSelect: true, 
                  itemCheckBox: true,
                  data: unique(ticketData, 'state'),
                  filter: {
                    header: true,
                    emptyText: 'Search'
                  }
                },{
                  index: 'createDate',
                  title: 'Дата',
                  type: 'date',
                  sortable: true,
                  format: {
                    read: 'Y-m-d H:i:s',
                    write: getFormattedDate()
                  }
                },{
                  index: 'viewBtn',
                  cellAlign: 'center',
                  editable: false,
                  ellipsis: false,
                  width: 60
                }]
              });

            });

          </script>
          <div class="col-md-2"/>
          <div class="col-md-8">
              <t t-if="ticket_count > 0"> 
                <div id="ticketgrid"></div>
              </t>
              <t t-if="ticket_count == 0">
                <div class="mt16 mb16">
                  <h2 class="text-center">You have no support tickets</h2>
                </div>
              </t>
          </div>
          <div class="col-md-2"/>
        </div>
        
    </t>
  </template>
</data>
</odoo>